(e=>{if(!e.WYSIWYG){let u={selector:".wysiwyg",height:360,placeholder:"Start typing...",sanitize:!0,autosaveKey:null,toolbar:["undo","redo","|","bold","italic","underline","strike","removeFormat","|","h1","h2","h3","p","|","fontFamily","fontSize","fontColor","bgColor","|","alignLeft","alignCenter","alignRight","|","ul","ol","indent","outdent","|","link","image","table","hr","|","code","quote","|","toggleSource","fullscreen"],uploadUrl:null,uploadFieldName:"image",uploadHeaders:{},onUploadProgress:null,parseUploadResponse:e=>e&&(e.url||e.data&&e.data.url)||null,uploadHandler:null,plugins:[]},p=[],h={bold:'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M7 7h5a3 3 0 010 6H7zM7 13h6a3 3 0 110 6H7z"/></svg>',italic:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 4h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 20h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M15 4L9 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',underline:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 3v7a7 7 0 0014 0V3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M4 21h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',strike:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',removeFormat:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M12 3v14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',alignLeft:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="2" rx="1" fill="currentColor"/><rect x="3" y="9" width="12" height="2" rx="1" fill="currentColor"/><rect x="3" y="14" width="18" height="2" rx="1" fill="currentColor"/></svg>',alignCenter:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="2" rx="1" fill="currentColor"/><rect x="6" y="9" width="12" height="2" rx="1" fill="currentColor"/><rect x="3" y="14" width="18" height="2" rx="1" fill="currentColor"/></svg>',alignRight:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="2" rx="1" fill="currentColor"/><rect x="9" y="9" width="12" height="2" rx="1" fill="currentColor"/><rect x="3" y="14" width="18" height="2" rx="1" fill="currentColor"/></svg>',ul:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="6" cy="7" r="1.5" fill="currentColor"/><circle cx="6" cy="12" r="1.5" fill="currentColor"/><circle cx="6" cy="17" r="1.5" fill="currentColor"/><rect x="10" y="6" width="11" height="2" rx="1" fill="currentColor"/><rect x="10" y="11" width="11" height="2" rx="1" fill="currentColor"/><rect x="10" y="16" width="11" height="2" rx="1" fill="currentColor"/></svg>',ol:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><text x="2" y="8" font-size="7" fill="currentColor">1.</text><text x="2" y="13" font-size="7" fill="currentColor">2.</text><text x="2" y="18" font-size="7" fill="currentColor">3.</text><rect x="10" y="6" width="11" height="2" rx="1" fill="currentColor"/><rect x="10" y="11" width="11" height="2" rx="1" fill="currentColor"/><rect x="10" y="16" width="11" height="2" rx="1" fill="currentColor"/></svg>',indent:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="2" rx="1" fill="currentColor"/><rect x="8" y="9" width="12" height="2" rx="1" fill="currentColor"/><rect x="8" y="14" width="12" height="2" rx="1" fill="currentColor"/><path d="M3 11l3 3-3 3V11z" fill="currentColor"/></svg>',outdent:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="4" width="16" height="2" rx="1" fill="currentColor"/><rect x="4" y="9" width="12" height="2" rx="1" fill="currentColor"/><rect x="4" y="14" width="12" height="2" rx="1" fill="currentColor"/><path d="M21 11l-3 3 3 3V11z" fill="currentColor"/></svg>',link:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 14a5 5 0 007.07 0l3-3a5 5 0 00-7.07-7.07l-1 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 10a5 5 0 00-7.07 0l-3 3a5 5 0 007.07 7.07l1-1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',image:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M21 15l-5-5-8 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',table:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/><path d="M3 9h18M3 15h18M9 3v18M15 3v18" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>',hr:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="11" width="18" height="2" rx="1" fill="currentColor"/></svg>',code:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6L2 12l6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',quote:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 17h4v-6H7v6zM13 17h4v-6h-4v6z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>',toggleSource:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8 16l-4-4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 8l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',fullscreen:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 9V3h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 15v6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 15v6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 9V3h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',fontColor:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" fill="none"/><circle cx="12" cy="12" r="4" fill="currentColor"/></svg>',bgColor:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" fill="none"/><rect x="7" y="7" width="10" height="10" fill="currentColor"/></svg>',fontSize:'<svg width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><text x="2" y="16" font-size="12" fill="currentColor">A</text></svg>'},g=`
.wysiwyg-wrapper{border:1px solid #e2e8f0;border-radius:8px;background:#fff;color:#111;font-family:Inter,system-ui,Arial}
.wysiwyg-toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:#f8fafc;border-bottom:1px solid #eef2f7;scrollbar-width:none}
.wysiwyg-toolbar::-webkit-scrollbar{display:none}
.wysiwyg-toolbar button, .wysiwyg-toolbar select, .wysiwyg-toolbar input[type="color"]{background:transparent;border:1px solid #e6edf3;padding:6px 8px;border-radius:6px;cursor:pointer}
.wysiwyg-toolbar button{-webkit-tap-highlight-color:transparent}
.wysiwyg-toolbar button:focus-visible{outline:2px solid #94a3b8;outline-offset:2px}
.wysiwyg-toolbar button svg{display:block;width:16px;height:16px}
.wysiwyg-editor{min-height:120px;padding:14px;outline:none;color:inherit;word-break:break-word}
.wysiwyg-editor[contenteditable='true']{cursor:text}
.wysiwyg-source{width:100%;box-sizing:border-box;padding:10px;border:none;font-family:monospace;min-height:140px}
.wysiwyg-hidden{display:none}
.wysiwyg-progress{height:6px;background:#f1f5f9;border-radius:6px;overflow:hidden;margin-top:6px}
.wysiwyg-progress > i{display:block;height:100%;width:0%;background:#2563eb;border-radius:6px}
.wysiwyg-dialog{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;border-radius:8px;padding:14px;border:1px solid #e6edf3;box-shadow:0 10px 30px rgba(2,6,23,0.08);z-index:9999;width:420px;max-width:92%}
.wysiwyg-dialog .row{margin-bottom:8px}
.wysiwyg-dialog label{display:block;font-size:13px;color:#334155;margin-bottom:6px}
.wysiwyg-dialog input[type=text], .wysiwyg-dialog textarea{width:100%;padding:8px;border:1px solid #e6edf3;border-radius:6px}
.wysiwyg-fullscreen{position:fixed;inset:0;background:#fff;z-index:9998;padding:18px;overflow:auto;padding-left:calc(18px + env(safe-area-inset-left,0));padding-right:calc(18px + env(safe-area-inset-right,0));padding-top:calc(18px + env(safe-area-inset-top,0));padding-bottom:calc(18px + env(safe-area-inset-bottom,0))}

/* Mobile/touch optimizations */
@media (max-width: 640px), (pointer: coarse) {
  .wysiwyg-toolbar{position:sticky;top:calc(env(safe-area-inset-top,0));z-index:1000;flex-wrap:nowrap;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;gap:4px;padding:8px 6px}
  .wysiwyg-toolbar button, .wysiwyg-toolbar select, .wysiwyg-toolbar input[type="color"]{min-width:40px;min-height:40px;padding:8px !important}
  .wysiwyg-dialog{inset:env(safe-area-inset-top,0) env(safe-area-inset-right,0) env(safe-area-inset-bottom,0) env(safe-area-inset-left,0);left:auto;top:auto;transform:none;width:auto;max-width:100%;height:auto;max-height:100%;border-radius:0}
}
`;document.addEventListener("selectionchange",()=>{p.forEach(e=>{try{L(e)}catch(e){}})}),window.addEventListener("beforeunload",()=>{document.querySelectorAll("img").forEach(e=>{if(e.dataset&&e.dataset._blobUrl)try{URL.revokeObjectURL(e.dataset._blobUrl)}catch(e){}})}),e.WYSIWYG={init:function(e,t){e=e||u.selector;let r=[];return"string"==typeof e?r=Array.from(document.querySelectorAll(e)):e instanceof NodeList||Array.isArray(e)?r=Array.from(e):e instanceof HTMLTextAreaElement&&(r=[e]),r.map(e=>o(e,t))},sanitizeHtml:v};try{e.KriaLite||(e.KriaLite=e.WYSIWYG)}catch(e){}function w(e,d){let a=document.createElement("div"),l=(a.className="wysiwyg-toolbar",d._buttons={},(e,t,r,o={})=>{var i=document.createElement("button"),n=(i.type="button",i.dataset.cmd=e,i.title=o.title||t||e,i.setAttribute("aria-pressed","false"),d&&d.options&&d.options.icons&&d.options.icons[e]||h[e]);return n?(i.innerHTML=n,i.style.display="inline-flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.width=o.width||"36px",i.style.height=o.height||"36px",i.style.padding="6px"):i.textContent=t||e,i.addEventListener("click",e=>{try{r(e)}catch(e){console.error("toolbar handler error",e)}d&&setTimeout(()=>L(d),10)}),a.appendChild(i),d._buttons[e]=i}),s=(e,t)=>{let r=document.createElement("select");return e.forEach(e=>{var t=document.createElement("option");t.value=e.value,t.textContent=e.label,r.appendChild(t)}),r.addEventListener("change",e=>t(e.target.value)),a.appendChild(r),r},c=(t,e="Color")=>{var r=document.createElement("input");return r.type="color",r.title=e,r.addEventListener("input",e=>t(e.target.value)),a.appendChild(r),r};return e.forEach(e=>{var t,r,o,i,n;if("|"===e)(t=document.createElement("div")).style.width="8px",a.appendChild(t);else switch(e){case"undo":l("undo","Undo",()=>{d&&"function"==typeof d._undo?d._undo():y("undo")},{title:"Undo (Ctrl/Cmd+Z)"});break;case"redo":l("redo","Redo",()=>{d&&"function"==typeof d._redo?d._redo():y("redo")},{title:"Redo (Shift+Ctrl/Cmd+Z)"});break;case"bold":l("bold","Bold",()=>{y("bold"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Bold"});break;case"italic":l("italic","Italic",()=>{y("italic"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Italic"});break;case"underline":l("underline","Underline",()=>{y("underline"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Underline"});break;case"strike":l("strike","Strike",()=>{y("strikeThrough"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Strike"});break;case"removeFormat":l("removeFormat","Remove format",()=>{y("removeFormat"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Remove formatting"});break;case"h1":l("h1","H1",()=>{y("formatBlock","H1"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Heading 1"});break;case"h2":l("h2","H2",()=>{y("formatBlock","H2"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Heading 2"});break;case"h3":l("h3","H3",()=>{y("formatBlock","H3"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Heading 3"});break;case"p":l("p","P",()=>{y("formatBlock","P"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Paragraph"});break;case"fontFamily":s([{value:"",label:"Font family"},{value:"Inter",label:"Inter"},{value:"Arial",label:"Arial"},{value:"Helvetica",label:"Helvetica"},{value:"Times New Roman",label:"Times New Roman"},{value:"Georgia",label:"Georgia"},{value:"Verdana",label:"Verdana"},{value:"Tahoma",label:"Tahoma"},{value:"Trebuchet MS",label:"Trebuchet MS"},{value:"Courier New",label:"Courier New"},{value:"Roboto",label:"Roboto"},{value:"Monospace",label:"Monospace"}],e=>{e&&(y("fontName",e),d)&&d._saveSnapshot&&d._saveSnapshot()});break;case"fontSize":s([{value:"",label:"Font size"},{value:"1",label:"Small"},{value:"3",label:"Normal"},{value:"5",label:"Large"},{value:"7",label:"Huge"}],e=>{y("fontSize",e||3),d&&d._saveSnapshot&&d._saveSnapshot()});break;case"fontColor":c(e=>{y("foreColor",e),d&&d._saveSnapshot&&d._saveSnapshot()},"Font color");break;case"bgColor":c(e=>{y("hiliteColor",e),d&&d._saveSnapshot&&d._saveSnapshot()},"Background color");break;case"alignLeft":l("alignLeft","Align left",()=>{y("justifyLeft"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Align left"});break;case"alignCenter":l("alignCenter","Align center",()=>{y("justifyCenter"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Align center"});break;case"alignRight":l("alignRight","Align right",()=>{y("justifyRight"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Align right"});break;case"ul":l("ul","Bulleted list",()=>{y("insertUnorderedList"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Bulleted list"});break;case"ol":l("ol","Numbered list",()=>{y("insertOrderedList"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Numbered list"});break;case"indent":l("indent","Indent",()=>{y("indent"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Indent"});break;case"outdent":l("outdent","Outdent",()=>{y("outdent"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Outdent"});break;case"link":l("link","Link",()=>m(d),{title:"Insert link (Ctrl/Cmd+K)"});break;case"image":l("image","Image",()=>{{var l=d;let{dlg:i,close:n}=f(`
      <div>
        <div class="row"><label>Image URL</label><input type="text" id="wimg-url" placeholder="https://..."></div>
        <div class="row"><label>Or choose file</label><input type="file" id="wimg-file" accept="image/*"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="wimg-cancel">Cancel</button><button id="wimg-insert">Insert</button></div>
      </div>`),a=i.querySelector("#wimg-file");i.querySelector("#wimg-cancel").addEventListener("click",n),i.querySelector("#wimg-insert").addEventListener("click",async()=>{var e,t,r=i.querySelector("#wimg-url").value.trim(),o=a.files&&a.files[0];o?(e=URL.createObjectURL(o),(t=document.createElement("img")).src=e,t.style.maxWidth="100%",b(t,l.editorEl),l._saveSnapshot(),n(),x(o,t,l).catch(e=>{console.warn(e)})):r?(y("insertHTML",`<img src="${S(r)}" style="max-width:100%">`),l._saveSnapshot(),n()):alert("Enter a URL or choose a file")})}},{title:"Insert image"});break;case"table":l("table","Table",()=>{{var s=d;let{dlg:e,close:t}=f(`
      <div>
        <div class="row"><label>Rows</label><input type="text" id="wtable-rows" value="2" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 3"></div>
        <div class="row"><label>Columns</label><input type="text" id="wtable-cols" value="2" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 2"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end"><button id="wtable-cancel">Cancel</button><button id="wtable-insert">Insert</button></div>
      </div>`),r=window.getSelection(),n=[];if(r&&r.rangeCount)for(let e=0;e<r.rangeCount;e++)n.push(r.getRangeAt(e).cloneRange());let a=e.querySelector("#wtable-rows"),l=e.querySelector("#wtable-cols");e.querySelector("#wtable-cancel").addEventListener("click",t),e.querySelector("#wtable-insert").addEventListener("click",()=>{var e=parseInt(a.value,10),r=parseInt(l.value,10);if(!Number.isFinite(e)||e<=0)alert("Enter a valid positive number of rows");else if(!Number.isFinite(r)||r<=0)alert("Enter a valid positive number of columns");else{try{let t=window.getSelection();t.removeAllRanges(),n.length&&n.forEach(e=>t.addRange(e))}catch(e){}s&&s.editorEl&&s.editorEl.focus();{var[e,o=2,i=2]=[s,e,r];let t='<table border="1" style="border-collapse:collapse;width:100%">';for(let e=0;e<o;e++){t+="<tr>";for(let e=0;e<i;e++)t+='<td style="padding:6px"> </td>';t+="</tr>"}y("insertHTML",t+="</table><p></p>"),e._saveSnapshot()}t()}})}},{title:"Insert table"});break;case"hr":l("hr","HR",()=>{y("insertHorizontalRule"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Horizontal rule"});break;case"code":l("code","Code",()=>{var e=d,t=k();y("insertHTML",t?`<pre><code>${C(t)}</code></pre>`:"<pre><code>// code here</code></pre>"),e._saveSnapshot()},{title:"Code block"});break;case"quote":l("quote","Quote",()=>{y("formatBlock","BLOCKQUOTE"),d&&d._saveSnapshot&&d._saveSnapshot()},{title:"Blockquote"});break;case"toggleSource":l("toggleSource","Source",()=>{var e,t=d,{editorEl:r,sourceEl:o}=t;r&&o&&(o.classList.contains("wysiwyg-hidden")?(o.value=r.innerHTML,r.classList.add("wysiwyg-hidden"),o.classList.remove("wysiwyg-hidden"),o.focus()):(e=o.value,r.innerHTML=t.options.sanitize?v(e):e,o.classList.add("wysiwyg-hidden"),r.classList.remove("wysiwyg-hidden"),t._saveSnapshot()))},{title:"Toggle source"});break;case"fullscreen":l("fullscreen","Fullscreen",()=>{var e;(e=d)&&(e.fullscreen?(e.wrapper.classList.remove("wysiwyg-fullscreen"),e.fullscreen=!1):(e._origParent=e.wrapper.parentNode,e._origNext=e.wrapper.nextSibling,e.wrapper.classList.add("wysiwyg-fullscreen"),e.fullscreen=!0))},{title:"Fullscreen"});break;default:o=()=>y(e),i={title:r=e},(n=document.createElement("button")).type="button",n.innerHTML=r,i.title&&(n.title=i.title),n.addEventListener("click",o),a.appendChild(n)}}),a}function v(e){for(var t=document.createElement("div"),r=(t.innerHTML=e,t.querySelectorAll("script,style,iframe,object,embed,link,meta").forEach(e=>e.remove()),document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,null)),o=[];r.nextNode();)o.push(r.currentNode);return o.forEach(o=>{Array.from(o.attributes||[]).forEach(e=>{var t=e.name.toLowerCase(),r=(e.value||"").toLowerCase();(t.startsWith("on")||"href"===t&&r.startsWith("javascript:"))&&o.removeAttribute(e.name)})}),t.innerHTML}function y(t,e=null){try{document.execCommand(t,!1,e)}catch(e){console.warn("execCommand failed",t,e)}}function f(e,t){let r=document.createElement("div");return r.className="wysiwyg-dialog",r.innerHTML=e,document.body.appendChild(r),{dlg:r,close:function(){try{r.remove()}catch(e){}"function"==typeof t&&t()}}}function m(r){var t=window.getSelection();let o=[];if(t&&t.rangeCount)for(let e=0;e<t.rangeCount;e++)o.push(t.getRangeAt(e).cloneRange());let{dlg:i,close:n}=f(`
    <div>
      <div class="row"><label>URL</label><input type="text" id="wlink-url" placeholder="https://example.com"></div>
      <div class="row"><label>Text</label><input type="text" id="wlink-text" value="${S(k()||"")}"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button id="wlink-cancel">Cancel</button><button id="wlink-insert">Insert</button></div>
    </div>`);i.querySelector("#wlink-cancel").addEventListener("click",n),i.querySelector("#wlink-insert").addEventListener("click",()=>{var e=i.querySelector("#wlink-url").value.trim(),t=i.querySelector("#wlink-text").value.trim();if(e){try{let t=window.getSelection();t.removeAllRanges(),o.length&&o.forEach(e=>t.addRange(e))}catch(e){}t?y("insertHTML",`<a href="${S(e)}" target="_blank" rel="noopener">${C(t)}</a>`):y("createLink",e),r&&r._saveSnapshot&&r._saveSnapshot(),n()}else alert("URL required")})}async function x(e,t,r){if("function"==typeof r.options.uploadHandler)try{var o=await r.options.uploadHandler(e,{onProgress:e=>l(r,e)}),i="string"==typeof o?o:r.options.parseUploadResponse?r.options.parseUploadResponse(o):o&&o.url;i&&(t.src=i,r._saveSnapshot())}catch(e){console.error("uploadHandler error",e)}else if(r.options.uploadUrl)try{var n=await((i,e={},n)=>{let a=e.uploadUrl,l=e.uploadFieldName||"image",s=e.uploadHeaders||{};return a?new Promise((e,t)=>{let r=new XMLHttpRequest;var o=new FormData;o.append(l,i,i.name),r.open("POST",a,!0),Object.keys(s).forEach(e=>{try{r.setRequestHeader(e,s[e])}catch(e){}}),r.upload.onprogress=e=>{e.lengthComputable&&"function"==typeof n&&n(Math.round(e.loaded/e.total*100),e.loaded,e.total)},r.onreadystatechange=()=>{if(4===r.readyState)if(200<=r.status&&r.status<300)try{e(JSON.parse(r.responseText))}catch(e){t(new Error("Invalid JSON from upload endpoint"))}else t(new Error("Upload failed: "+r.status))},r.onerror=()=>t(new Error("Network error")),r.send(o)}):Promise.reject(new Error("uploadUrl not specified"))})(e,r.options,e=>l(r,e)),a=r.options.parseUploadResponse?r.options.parseUploadResponse(n):n&&n.url;a&&(t.src=a)}catch(e){console.error("uploadFileXHR error",e)}}function l(e,t){e&&(e=e.wrapper.querySelector(".wysiwyg-progress"))&&(e.firstElementChild.style.width=Math.max(0,Math.min(100,t||0))+"%")}function b(e,t){var r,o=window.getSelection();o&&o.rangeCount?((r=o.getRangeAt(0)).deleteContents(),r.insertNode(e),r.setStartAfter(e),r.setEndAfter(e),o.removeAllRanges(),o.addRange(r)):t.appendChild(e)}function k(){var t=window.getSelection();if(!t||0===t.rangeCount)return"";var r=document.createElement("div");for(let e=0;e<t.rangeCount;e++)r.appendChild(t.getRangeAt(e).cloneContents());return r.innerHTML}function C(e){return String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e])}function S(e){return C(e).replace(/"/g,"&quot;")}function _(e){var t,r;e&&({editorEl:e,textarea:t,options:r}=e||{},t)&&(t.value=r&&r.sanitize?v(e&&e.innerHTML||""):e&&e.innerHTML||"")}function L(i){if(i&&i._buttons){let r=i._buttons,o={bold:document.queryCommandState("bold"),italic:document.queryCommandState("italic"),underline:document.queryCommandState("underline"),strike:document.queryCommandState("strikeThrough")};Object.keys(o).forEach(e=>{var t=r[e];t&&(t.classList.toggle("active",!!o[e]),t.setAttribute("aria-pressed",o[e]?"true":"false"))});var e=document.queryCommandState("insertUnorderedList"),t=document.queryCommandState("insertOrderedList");r.ul&&(r.ul.classList.toggle("active",!!e),r.ul.setAttribute("aria-pressed",e?"true":"false")),r.ol&&(r.ol.classList.toggle("active",!!t),r.ol.setAttribute("aria-pressed",t?"true":"false")),["alignLeft","alignCenter","alignRight"].forEach(e=>{let t=!1;"alignLeft"===e&&(t=document.queryCommandState("justifyLeft")),"alignCenter"===e&&(t=document.queryCommandState("justifyCenter")),"alignRight"===e&&(t=document.queryCommandState("justifyRight")),r[e]&&(r[e].classList.toggle("active",!!t),r[e].setAttribute("aria-pressed",t?"true":"false"))});try{var n=window.getSelection();let e=n&&n.anchorNode,t=(e&&3===e.nodeType&&(e=e.parentNode),null);for(;e&&e!==i.editorEl&&(1!==e.nodeType||!(t=e.tagName));)e=e.parentNode;t=t?t.toUpperCase():null,r.h1&&r.h1.classList.toggle("active","H1"===t),r.h2&&r.h2.classList.toggle("active","H2"===t),r.h3&&r.h3.classList.toggle("active","H3"===t),r.p&&r.p.classList.toggle("active",!t||"P"===t||"DIV"===t),r.quote&&r.quote.classList.toggle("active","BLOCKQUOTE"===t),r.code&&r.code.classList.toggle("active","PRE"===t)}catch(e){}try{var a=window.getSelection();let e=a&&a.anchorNode,t=!1;for(;e&&e!==i.editorEl;){if(1===e.nodeType&&"A"===e.tagName){t=!0;break}e=e.parentNode}r.link&&(r.link.classList.toggle("active",!!t),r.link.setAttribute("aria-pressed",t?"true":"false"))}catch(e){}try{var l=window.getSelection();let e=!1;if(l&&l.rangeCount){var s=document.createElement("div");for(let e=0;e<l.rangeCount;e++)s.appendChild(l.getRangeAt(e).cloneContents());s.querySelector&&s.querySelector("img")&&(e=!0)}r.image&&r.image.classList.toggle("active",!!e)}catch(e){}}}function o(e,t){document.getElementById("wysiwyg-widget-styles")||((r=document.createElement("style")).id="wysiwyg-widget-styles",r.textContent=g,document.head.appendChild(r));var r=Object.assign({},u,t||{}),t=document.createElement("div"),o=(t.className="wysiwyg-wrapper",document.createElement("div")),i=(o.className="wysiwyg-editor",o.contentEditable=!0,o.style.minHeight=(r.height||300)+"px",o.innerHTML=e.value||"",document.createElement("textarea"));i.className="wysiwyg-source wysiwyg-hidden",i.style.minHeight=(r.height||300)+"px";let n={textarea:e,wrapper:t,editorEl:o,sourceEl:i,options:r,fullscreen:!1};p.push(n);var a,l,s,d,c=w(r.toolbar,n),h=(t.appendChild(c),t.appendChild(o),t.appendChild(i),e.style.display="none",e.parentNode.insertBefore(t,e.nextSibling),(a=n)._history=[],a._historyIndex=-1,a._saveSnapshot=function(){try{var e=a.editorEl.innerHTML;0<=a._historyIndex&&a._history[a._historyIndex]===e||(a._history.splice(a._historyIndex+1),a._history.push(e),a._historyIndex=a._history.length-1,100<a._history.length&&a._history.shift())}catch(e){console.warn("history save failed",e)}},a._undo=function(){0<a._historyIndex&&(a._historyIndex--,a.editorEl.innerHTML=a._history[a._historyIndex],_(a))},a._redo=function(){a._historyIndex<a._history.length-1&&(a._historyIndex++,a.editorEl.innerHTML=a._history[a._historyIndex],_(a))},a._saveSnapshot(),l=n,window.addEventListener("keydown",l._shortcuts=function(e){var t=e.ctrlKey||e.metaKey;t&&!e.shiftKey&&"z"===e.key.toLowerCase()&&(e.preventDefault(),"function"==typeof l._undo?l._undo():y("undo")),t&&e.shiftKey&&"z"===e.key.toLowerCase()&&(e.preventDefault(),"function"==typeof l._redo?l._redo():y("redo")),t&&"b"===e.key.toLowerCase()&&(e.preventDefault(),y("bold"),l._saveSnapshot()),t&&"i"===e.key.toLowerCase()&&(e.preventDefault(),y("italic"),l._saveSnapshot()),t&&"u"===e.key.toLowerCase()&&(e.preventDefault(),y("underline"),l._saveSnapshot()),t&&"k"===e.key.toLowerCase()&&(e.preventDefault(),m(l)),t&&"s"===e.key.toLowerCase()&&(e.preventDefault(),_(l),"function"==typeof l.options.onSave)&&l.options.onSave(l.getHTML())}),(s=n).editorEl.addEventListener("paste",async function(e){e.preventDefault();var t=e.clipboardData||window.clipboardData;if(t)if(t.files&&t.files.length)for(let e=0;e<t.files.length;e++){var r,o,i=t.files[e];i.type&&i.type.startsWith("image/")&&(r=URL.createObjectURL(i),(o=document.createElement("img")).src=r,o.style.maxWidth="100%",o.dataset._blobUrl=r,b(o,s.editorEl),s._saveSnapshot(),_(s),x(i,o,s).catch(e=>{console.warn("paste image upload failed",e)}))}else{var n=t.getData&&t.getData("text/html");if(n&&n.trim()){y("insertHTML",s.options&&s.options.sanitize?v(n):n),s._saveSnapshot(),_(s);try{L(s)}catch(e){}}else{n=t.getData&&(t.getData("text/plain")||"");if(n){y("insertHTML",n.split(/\r?\n/).map(e=>`<p>${C(e)}</p>`).join("")),s._saveSnapshot(),_(s);try{L(s)}catch(e){}}}}}),n);if(h.options.autosaveKey){let e=h.options.autosaveKey;c=localStorage.getItem(e);c&&(h.editorEl.innerHTML=c),h._autosaveTimer=setInterval(()=>{localStorage.setItem(e,h.editorEl.innerHTML)},3e3)}(d=n).getHTML=()=>d.editorEl.innerHTML,d.setHTML=e=>{d.editorEl.innerHTML=e,_(d),d._saveSnapshot()},d.getText=()=>d.editorEl.innerText,d.insertHtml=e=>{y("insertHTML",e),d._saveSnapshot()},d.destroy=()=>{try{d._autosaveTimer&&clearInterval(d._autosaveTimer),d._shortcuts&&window.removeEventListener("keydown",d._shortcuts),d.wrapper.remove(),d.textarea.style.display="",delete d.textarea._wysiwyg}catch(e){console.warn("destroy failed",e)}},o.addEventListener("input",()=>{_(n),n._saveSnapshot()}),i.addEventListener("input",()=>{}),e.addEventListener("change",()=>{n.editorEl.innerHTML=e.value||""});t=e.closest("form");return t&&t.addEventListener("submit",()=>_(n)),Array.isArray(r.plugins)&&r.plugins.forEach(e=>{try{e(n)}catch(e){console.warn("plugin failed",e)}}),e._wysiwyg=n}}})(window);